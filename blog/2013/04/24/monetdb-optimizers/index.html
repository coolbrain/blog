
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>MonetDB Optimizers - ForgeBrain</title>
  <meta name="author" content="ForgeBrain">

  
  <meta name="description" content="MonetDB 汇编语言优化器
设计MonetDB中间语言的首要理由是能对数据库查询有一个高层次的描述，且这种语言容易被front-end编译器产生，容易编码，优化和解析。 一个有效的优化器需要几种机制保证。它可以执行对代码碎片的标志性评估和收集结果来帮助进一步的抉择。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://coolbrain.github.com/blog/2013/04/24/monetdb-optimizers/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="ForgeBrain" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39361176-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:coolbrain.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            ForgeBrain
        </span>
       
           <span class="blue_dark">
             Hardworking.
           </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">MonetDB Optimizers</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-24T20:02:00+08:00" pubdate data-updated="true">Apr 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p><p><strong>MonetDB 汇编语言优化器</strong></p>
<p>设计MonetDB中间语言的首要理由是能对数据库查询有一个高层次的描述，且这种语言容易被front-end编译器产生，容易编码，优化和解析。</p>
<!-- more -->
<p>一个有效的优化器需要几种机制保证。它可以执行对代码碎片的标志性评估和收集结果来帮助进一步的抉择。原型情况就是一个优化器估计选择操作结果的大小。另外主要的问题是可以产生和发掘替代评估计划的空间。这种发掘可以发生在前端，也可以在运行的时候对查询碎片。</p>
<p><strong>优化器的基础</strong></p>
<p>1.生命周期的分析</p>
<p>优化器为了做一个抉择可能对代码块的特性可能有兴趣。在代码块中变量都有生命周期，用属性beginLifespan，endLifespan来表示。beginLifespan表示指令在哪里得到其第一个值，endLifespan表示最后指令在哪里被使用作为操作数或目标。如果然而，最后的使用在BARRIER块里，我们不能确定它的生命状态的结束，因为代码块redo可能模糊地使用它。对于这些情况我们关联endLifespan到跳出代码块。</p>
<p>在许多的情况，我们需要决定是否生命周期干扰了一个预先准备好的优化决定。在优化器的开始序列中，生命周期被计算一次。它会被维持去反映最准确的情况当优化基础代码时。特别是，这意味着任何的 move/remove/addition MAL指令调用不是为了重现计算就是为了进一步的传播。不清楚什么会是最好的策略。暂时我们只是重新计算。</p>
<p>在点pc指令中提到里所有的参数都会在指令qc见到且不会同时更新。把变量可能在代码块内声明都考虑进来。这可能使用BARRIER/CATCH 和 EXIT对计算。对于每一个MAL函数安全的属性相对容易决定。这种调用是为了访问MAL函数块和监视签名的参数。</p>
<p>任何的指令可能阻碍公共子表达式的识别。他充分地阻碍一个其参数列表与目标指令有非空的交集的不安全的函数。为了说明，考虑序列：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="n">L1</span> <span class="o">:=</span> <span class="n">f</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'> <span class="n">G1</span> <span class="o">:=</span> <span class="n">g</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'> <span class="n">l2</span> <span class="o">:=</span> <span class="n">f</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'> <span class="n">L2</span> <span class="o">:=</span> <span class="n">h</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>指令G1：=g(D, E, F) 阻塞如过G1 是｛A,B，C｝的别名。换言之，函数g()可能不安全和｛D，E，F｝和｛A,B，C｝有非空的交集。一个别名在以后的使用只能是只读。</p>
<p>MonetDB的执行优化前，设定生命周期的代码。</p></p></blockquote>

<figure class='code'><figcaption><span>设置变量的生命周期setLifespan  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Lifespan</span> <span class="nf">setLifespan</span><span class="p">(</span><span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">pc</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Lifespan</span> <span class="n">span</span><span class="o">=</span> <span class="n">newLifespan</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">memset</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">span</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LifespanRecord</span><span class="p">)</span><span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="n">prop</span> <span class="o">=</span> <span class="n">PropertyIndex</span><span class="p">(</span><span class="s">&quot;transparent&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">blk</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pc</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span> <span class="n">pc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">NOOPsymbol</span><span class="p">)</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">blockStart</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">prop</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>          <span class="n">depth</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">beginLifespan</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>              <span class="n">span</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">beginLifespan</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>              <span class="n">blk</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span> <span class="n">depth</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span> <span class="p">)</span>
</span><span class='line'>              <span class="n">span</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">lastUpdate</span><span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">blk</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">==</span> <span class="n">depth</span> <span class="p">)</span>
</span><span class='line'>              <span class="n">span</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">depth</span> <span class="p">)</span>
</span><span class='line'>              <span class="n">span</span><span class="p">[</span><span class="n">v</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>   <span class="cm">/* declared in outer scope*/</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * @-</span>
</span><span class='line'><span class="cm">      * At a block exit we can finalize all variables defined within that block.</span>
</span><span class='line'><span class="cm">      * This does not hold for dataflow blocks. They merely direct the execution</span>
</span><span class='line'><span class="cm">      * thread, not the syntactic scope.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">blockExit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>          <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">span</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="n">span</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">span</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">depth</span><span class="p">)</span>
</span><span class='line'>              <span class="n">span</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">prop</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
</span><span class='line'>              <span class="n">depth</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">span</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
</span><span class='line'>      <span class="n">span</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">endLifespan</span> <span class="o">=</span> <span class="n">pc</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span><span class="cm">/* generate them before the end */</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">span</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>2.流分析 </p>
<p>在许多优化规则里，语句间的数据流依赖尤其重要。MAL语言编码一个多源，多节点的数据流网络。优化器特别提取部分的工作流和使用语言的属性去枚举语义相等的解决方案，在给定的代价模型这出现导致更好的性能。流图在许多优化步骤里面扮演着重要的角色。什么是原始的和什么存储结构是最足够的是不清楚的。暂时我们引入必要的操作和对程序直接的评估。</p>
<p>对于每个变量我们应该确定他稳定的范围。在流图中的终点描述为不会产生永久数据的dead-code。当你知道这没有影响时，可以把它去掉。Side-effect自由评估应该在前端被知的属性。暂时，我们假设对于系统所有操作都是已知的。属性“不安全”是保留去识别这靠不住的情况。特别的是，一个bun-insert操作是不安全的，因为它改变了其中一个参数。</p>
<p><strong>MonetDB优化器详解：</strong></p>
<p>1.累加器评估:</p>
<p>批量的算术运算相当昂贵，因为对于每个表达式new BATs被创建。这内存饥饿被减少通过探测累加处理的机会，如，一个（临时）的变量被重写。如</p></p></blockquote>

<figure class='code'><figcaption><span>考虑下列程序片段：  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="nl">t3:</span><span class="o">=</span><span class="n">batcalc</span><span class="p">.</span><span class="o">*</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class='line'> <span class="nl">t4:</span><span class="o">=</span><span class="n">batcalc</span><span class="p">,</span><span class="o">+</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t3</span><span class="p">);</span>
</span><span class='line'> <span class="n">optimizer</span><span class="p">.</span><span class="n">accumulators</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>如果变量t2是临时变量且不会在以后的程序块用到，我们可以重用它的存储空间和在剩余的代码中传播其别名。</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="n">batcalc</span><span class="p">.</span><span class="o">*</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span><span class='line'> <span class="nl">t4:</span><span class="o">=</span><span class="n">batcalc</span><span class="p">.</span><span class="o">+</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>这实现是直接的。它刚刚只是处理了在BATCALC可用的算术操作。这集合会慢慢地扩展的。关键的决定是去决定是否我们可以重写其中一个参数。在编译的时候，这是很难去检测的，如参数可能是绑定操作或代表一个通过永久BAT表示的视图的结果。因此，编译器注入调用ALGEBRA.REUSE()通过拷贝避免重写永久的BATs。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB 累加器优化器代码：  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">OPTaccumulatorsImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span><span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Module</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">nspace</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Lifespan</span> <span class="n">span</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>     <span class="cm">/* to fool compilers */</span>
</span><span class='line'>  <span class="n">span</span> <span class="o">=</span> <span class="n">setLifespan</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">span</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">old</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>  <span class="n">limit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">slimit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="n">batcalcRef</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">OPTDEBUGaccumulators</span>
</span><span class='line'>          <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* unary operation, avoid clash with binary */</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">getLastUpdate</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="cm">/* only consider the last update to this variable */</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="o">==</span><span class="mi">1</span>  <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">b1</span> <span class="o">=</span><span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;=</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">b2</span> <span class="o">=</span><span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">&lt;=</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">b1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">b2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>              <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>              <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="cm">/* binary/unary operation, check arguments for being candidates */</span>
</span><span class='line'>          <span class="n">q</span><span class="o">=</span> <span class="n">copyInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">p</span><span class="o">=</span> <span class="n">pushBit</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">b1</span><span class="p">);</span>
</span><span class='line'>          <span class="n">p</span><span class="o">=</span> <span class="n">pushBit</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">b2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">typeChecker</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">typechk</span> <span class="o">==</span> <span class="n">TYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">OPTDEBUGaccumulators</span><span class="p">{</span>
</span><span class='line'>                  <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;# Failed typecheck&quot;</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="cm">/* reset instruction error buffer */</span>
</span><span class='line'>              <span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">errbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>              <span class="n">mb</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>              <span class="n">freeInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>              <span class="n">p</span><span class="o">=</span><span class="n">q</span><span class="p">;</span> <span class="cm">/* restore */</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
</span><span class='line'>              <span class="n">OPTDEBUGaccumulators</span><span class="p">{</span>
</span><span class='line'>                  <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;#Found accumulation candidate &quot;</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;%d: %d(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>                  <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="n">freeInstruction</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span><span class='line'>              <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">OPTDEBUGaccumulators</span>
</span><span class='line'>              <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_accumulators:%d accumulations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>2.别名的去除：</p>
<p>任务 OPTIMIZER.ALIASREMOVAL()浏览程序寻找简单赋值语句，如，V:=W，它用W替代了所有的接下来的V，条件是V只是被赋值一次和W在剩下的代码中不会改变。特殊的例子在迭代的代码块中，如下所示：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>         <span class="nl">i:</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>         <span class="nl">b:</span><span class="o">=</span><span class="s">&quot;done&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">barrier</span>  <span class="n">go</span><span class="o">:=</span><span class="nb">true</span><span class="p">;</span>
</span><span class='line'>         <span class="nl">c:</span><span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>         <span class="nl">d:</span><span class="o">=</span><span class="s">&quot;step&quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="nl">v:</span><span class="o">=</span><span class="n">d</span><span class="p">;</span>
</span><span class='line'>         <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
</span><span class='line'>         <span class="nl">i:</span><span class="o">=</span><span class="n">c</span><span class="p">;</span>
</span><span class='line'>  <span class="n">redo</span> <span class="n">go</span><span class="o">:=</span><span class="n">i</span> <span class="n">lower</span> <span class="n">than</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">exit</span> <span class="n">go</span><span class="p">;</span>
</span><span class='line'>         <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>         <span class="n">optimizer</span><span class="p">.</span><span class="n">aliasRemoval</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>字符常量被传入到PRINT()任务，当初始的赋值i：= 0 需要保留。代码块变成：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>         <span class="nl">i:</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">barrier</span>  <span class="n">go</span><span class="o">:=</span><span class="nb">true</span><span class="p">;</span>
</span><span class='line'>         <span class="nl">c:</span><span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>         <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">step</span><span class="s">&quot;);</span>
</span><span class='line'>         <span class="nl">i:</span><span class="o">=</span><span class="n">c</span><span class="p">;</span>
</span><span class='line'>  <span class="n">redo</span> <span class="n">go</span><span class="o">:=</span><span class="n">i</span> <span class="n">lower</span> <span class="n">than</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">exit</span> <span class="n">go</span><span class="p">;</span>
</span><span class='line'>         <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">);</span>
</span><span class='line'>         <span class="n">optimizer</span><span class="p">.</span><span class="n">aliasRemoval</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>下面是MonetDB别名去除优化的代码：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">OPTaliasesImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Lifespan</span> <span class="n">span</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="n">span</span><span class="o">=</span> <span class="n">setLifespan</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">span</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">alias</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">alias</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">alias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">limit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>      <span class="n">p</span><span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">OPTisAlias</span><span class="p">(</span><span class="n">p</span><span class="p">)){</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span> <span class="n">getLastUpdate</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span>  <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="n">getBeginLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span>  <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="n">getLastUpdate</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="p">){</span>
</span><span class='line'>              <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span><span class="o">=</span> <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">)];</span>
</span><span class='line'>              <span class="n">freeInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>              <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>              <span class="n">k</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>              <span class="n">OPTaliasRemap</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>          <span class="n">OPTaliasRemap</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * @-</span>
</span><span class='line'><span class="cm">  * The second phase is constant alias replacement should be implemented.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_aliases: %d removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>3.代码工厂化 ：</p>
<p>在大部分真正的情况，查询在它们的参数有稍微的差别被重复地调用。这种情况通过保持近期查询计划的缓存可以被查询优化器捕捉。在MonetDB上下文这样的查询被表示为参数化的MAL程序。进一步优化缓存函数将查询计划分成两块可能你有帮助。一个区域有不依赖于给定参数的操作和另一区域包含查询的核心使用所有的信息。这样的程序可以被MAL工厂表示，是一个可重入的查询计划。一个工厂化改变代码的例子如下：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">function</span> <span class="n">test</span><span class="p">(</span><span class="n">s</span><span class="o">:</span><span class="n">str</span><span class="p">)</span><span class="o">:</span><span class="n">lng</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">b:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">z:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">i:</span><span class="o">=</span> <span class="n">aggr</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="n">end</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">factorize</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="s">&quot;test&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>转变为下面的代码</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">factory</span> <span class="n">user</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">s</span><span class="o">:</span><span class="n">str</span><span class="p">)</span><span class="o">:</span><span class="n">lng</span><span class="p">;</span>
</span><span class='line'>  <span class="n">b</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">barrier</span> <span class="n">always</span> <span class="o">:=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>  <span class="n">z</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>  <span class="n">i</span> <span class="o">:=</span> <span class="n">aggr</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
</span><span class='line'>  <span class="n">yield</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="n">redo</span> <span class="n">always</span><span class="p">;</span>
</span><span class='line'><span class="n">exit</span> <span class="n">always</span><span class="p">;</span>
</span><span class='line'><span class="n">end</span> <span class="n">test</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>包含的工厂生成器是MAL工厂化的原型实现。被采用的方法是将程序分成两块和把其包装为MAL工厂。优化假设数据库表在工厂的生命时间中只访问一次不会改变。这样的变化应该被外面检测和接着是重启的工厂。一个重定义用户可以识别‘冻僵’的参数的模式会留给将来。因为查询会映射到人和可用的工厂去处理请求。暂时我们简单地重组计划的所有参数。工厂化的操作干扰OPTIMIZER.EXPRESSIONACCUMULATION() 因为这可能会重写参数。暂时，这在本地任务会被捕捉。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB工厂化优化代码  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">OPTfactorizeImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span>  <span class="n">v</span><span class="p">,</span> <span class="n">noop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">se</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">mbnew</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">,</span><span class="n">sig</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blkstart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">varused</span><span class="p">,</span> <span class="n">returnseen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retvar</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">second</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Lifespan</span> <span class="n">span</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>     <span class="cm">/* to fool compilers */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">span</span> <span class="o">=</span> <span class="n">setLifespan</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">span</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">varused</span> <span class="o">=</span> <span class="n">GDKmalloc</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">varused</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">varused</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* add parameters to use list */</span>
</span><span class='line'>  <span class="n">sig</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sig</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">varused</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">first</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstrPtr</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstrPtr</span><span class="p">));</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">first</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">varused</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">second</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstrPtr</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstrPtr</span><span class="p">));</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">second</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">varused</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">first</span><span class="p">[</span><span class="n">fk</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* to become a factory */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="n">se</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">varused</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
</span><span class='line'>              <span class="n">se</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* detect blocks they are moved to the second part */</span>
</span><span class='line'>      <span class="cm">/* a more clever scheme can be designed though */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">==</span> <span class="n">BARRIERsymbol</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">==</span> <span class="n">CATCHsymbol</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">blkstart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">blkstart</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>              <span class="n">blk</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">==</span> <span class="n">EXITsymbol</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">blk</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">blk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">blkstart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* beware, none of the target variables may live</span>
</span><span class='line'><span class="cm">        before the cut point.  */</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">getBeginLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span> <span class="n">i</span> <span class="o">||</span> <span class="o">!</span><span class="n">OPTallowed</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span class='line'>              <span class="n">se</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">==</span> <span class="n">RETURNsymbol</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">se</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">YIELDsymbol</span><span class="p">;</span>
</span><span class='line'>          <span class="n">returnseen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="n">retvar</span><span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">se</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">blk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>          <span class="n">first</span><span class="p">[</span><span class="n">fk</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>      <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">blkstart</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="cm">/* copy old block stuff */</span>
</span><span class='line'>              <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">blkstart</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">second</span><span class="p">[</span><span class="n">sk</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
</span><span class='line'>              <span class="n">fk</span> <span class="o">=</span> <span class="n">blkstart</span><span class="p">;</span>
</span><span class='line'>              <span class="n">blkstart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">second</span><span class="p">[</span><span class="n">sk</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>          <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="n">varused</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">second</span><span class="p">[</span><span class="n">sk</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>  <span class="cm">/* detect need for factorization, assume so */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">noop</span> <span class="o">||</span> <span class="n">sk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">varused</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">second</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="cm">/* remove the FToptimizer request */</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">first</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">=</span> <span class="n">FACTORYsymbol</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mbnew</span> <span class="o">=</span> <span class="p">(</span><span class="n">InstrPtr</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDKmalloc</span><span class="p">((</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">InstrPtr</span><span class="p">));</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">mbnew</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">varused</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">second</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span> <span class="o">=</span> <span class="n">mbnew</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fk</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">first</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* added control block */</span>
</span><span class='line'>  <span class="n">v</span> <span class="o">=</span> <span class="n">newVariable</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">GDKstrdup</span><span class="p">(</span><span class="s">&quot;always&quot;</span><span class="p">),</span> <span class="n">TYPE_bit</span><span class="p">);</span>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="n">newInstruction</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">ASSIGNsymbol</span><span class="p">);</span>
</span><span class='line'>  <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">BARRIERsymbol</span><span class="p">;</span>
</span><span class='line'>  <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>  <span class="n">p</span><span class="o">=</span> <span class="n">pushBit</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* finalize the factory */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">returnseen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span><span class="o">=</span> <span class="n">newInstruction</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">ASSIGNsymbol</span><span class="p">);</span>
</span><span class='line'>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">=</span> <span class="n">YIELDsymbol</span><span class="p">;</span>
</span><span class='line'>      <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="n">newInstruction</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">REDOsymbol</span><span class="p">);</span>
</span><span class='line'>  <span class="n">p</span><span class="o">=</span> <span class="n">pushReturn</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="n">newInstruction</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">EXITsymbol</span><span class="p">);</span>
</span><span class='line'>  <span class="n">p</span><span class="o">=</span> <span class="n">pushReturn</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* return a nil value */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">getVarType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">retvar</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TYPE_void</span><span class="p">){</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">newInstruction</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">RETURNsymbol</span><span class="p">);</span>
</span><span class='line'>      <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">retvar</span><span class="p">);</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cm">/* add END statement */</span>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">varused</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">second</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>4.删除强制转换：
<p>一个简单的优化器去除不需要的强制转换。它们可能来源于草率的代码生成器或函数调用决议决定。如 v:= calc.int(32);
成为一个简单地赋值，不需要函数调用。最主要的角色是一个编码一个优化算法的说明。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB删除强制转换的代码  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">coercionOptimizerStep</span><span class="p">(</span><span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">a</span> <span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">b</span> <span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t</span> <span class="o">=</span> <span class="n">getVarType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">getVarType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">ATOMname</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">removeInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span> <span class="cm">/* dead code */</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">p</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>          <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">p</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kt">int</span>  <span class="nf">OPTcoercionImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span><span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">calcRef</span><span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;calc&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>     <span class="cm">/* to fool compilers */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="n">calcRef</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">k</span><span class="o">=</span> <span class="n">coercionOptimizerStep</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">actions</span> <span class="o">+=</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span> <span class="n">k</span><span class="p">)</span> <span class="n">i</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * This optimizer affects the flow, but not the type and declaration</span>
</span><span class='line'><span class="cm">  * structure. A cheaper optimizer is sufficient.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_coercion: %d coersions applied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>5.消除公共子表达式: </p>
<p>消除公共子表达只涉及对程序块的扫描去检测重复出现的语句。最在说明最关键的问题是保证在重复指令里涉及到的参数都是不变的。对OPTIMIZER.COMMONTERMS()分析是相当简陋的。带有可能有side-effects的参数的所有函数应该被标志为‘不安全’。在MAL块中它们的使用跳出涉及所有对象的数据流图(BATs,所有的东西保存在盒子里）。消除子表达优化器位于相同指令的后面。只要发现相同的它就会停止。在我们用前面的变量代替表达式之前，我们假设我们还没有通过一个非空的代码块</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">b:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">c:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">d:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">e:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">k1:</span><span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">k2:</span><span class="o">=</span> <span class="mi">27</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">l:</span><span class="o">=</span> <span class="n">k1</span><span class="o">+</span><span class="n">k2</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">l2:</span><span class="o">=</span> <span class="n">k1</span><span class="o">+</span><span class="n">k2</span><span class="p">;</span>
</span><span class='line'>  <span class="nl">l3:</span><span class="o">=</span> <span class="n">l2</span><span class="o">+</span><span class="n">k1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">commonTerms</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>会被转换成代码块，开始的两个指令不是相同的，因为它们有side 影响</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">b</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">c</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">d</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span>
</span><span class='line'>  <span class="n">e</span> <span class="o">:=</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'>  <span class="n">l</span> <span class="o">:=</span> <span class="n">calc</span><span class="p">.</span><span class="o">+</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">27</span><span class="p">);</span>
</span><span class='line'>  <span class="n">l3</span> <span class="o">:=</span> <span class="n">calc</span><span class="p">.</span><span class="o">+</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="mi">24</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote></blockquote>

<figure class='code'><figcaption><span>MonetDB 消除公共子表达式的代码段  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>  <span class="nf">OPTcommonTermsImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">barrier</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span> 
</span><span class='line'>  <span class="cm">/* link all final constant expressions in a list */</span>
</span><span class='line'>  <span class="cm">/* it will help to find duplicate sql.bind calls */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">cstlist</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">vars</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>  <span class="n">alias</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="n">list</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vars</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">alias</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">vars</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">vars</span><span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">old</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>  <span class="n">limit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">slimit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="p">)</span>
</span><span class='line'>          <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">)];</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Link the statement to the previous use, based on the last argument.*/</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">candidate</span> <span class="o">=</span> <span class="n">vars</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">isVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">){</span>
</span><span class='line'>              <span class="cm">/* all instructions with constant tail are linked */</span>
</span><span class='line'>              <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cstlist</span><span class="p">;</span>
</span><span class='line'>              <span class="n">cstlist</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>              <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">vars</span><span class="p">[</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">];</span>
</span><span class='line'>          <span class="n">vars</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="n">candidate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ENDsymbol</span><span class="p">){</span>
</span><span class='line'>          <span class="cm">/* wrap up the remainder */</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>                  <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * @-</span>
</span><span class='line'><span class="cm">      * Any non-empty barrier block signals the end of this optimizer,</span>
</span><span class='line'><span class="cm">      * the impact of the block can affect the common code.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">barrier</span> <span class="o">|=</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">==</span> <span class="n">BARRIERsymbol</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">==</span> <span class="n">CATCHsymbol</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">!=</span><span class="n">EXITsymbol</span><span class="p">;</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">      * @-</span>
</span><span class='line'><span class="cm">      * Also block further optimization when you have seen an assert().</span>
</span><span class='line'><span class="cm">      * This works particularly for SQL, because it is not easy to track</span>
</span><span class='line'><span class="cm">      * the BAT identifier aliases to look for updates. The sql.assert</span>
</span><span class='line'><span class="cm">      * at least tells us that an update is planned.</span>
</span><span class='line'><span class="cm">      * Like all optimizer decisions, it is safe to stop.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="n">barrier</span> <span class="o">|=</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">assertRef</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">NOOPsymbol</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ASSIGNsymbol</span> <span class="o">||</span> <span class="n">barrier</span> <span class="cm">/* || p-&gt;retc == p-&gt;argc */</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>              <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;COMMON SKIPPED[%d] %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">barrier</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* from here we have a candidate to look for a match */</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#CANDIDATE[%d] &quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>      <span class="n">prop</span> <span class="o">=</span> <span class="n">hasSideEffects</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span> <span class="n">isUpdateInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="n">j</span> <span class="o">=</span>   <span class="n">isVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">?</span> <span class="n">cstlist</span><span class="o">:</span> <span class="n">candidate</span><span class="p">;</span>
</span><span class='line'>              
</span><span class='line'>      <span class="n">cnt</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">/</span> <span class="mi">128</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">/</span><span class="mi">128</span><span class="p">;</span>    <span class="cm">/* limit search depth */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">prop</span><span class="p">)</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(;</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="p">;</span> <span class="n">cnt</span><span class="o">--</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">j</span><span class="p">))</span> <span class="o">==</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">getModuleId</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>  <span class="p">){</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>          <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#CANDIDATE %d, %d  %d %d &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>
</span><span class='line'>              <span class="n">hasSameSignature</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">),</span>
</span><span class='line'>              <span class="n">hasSameArguments</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">));</span>
</span><span class='line'>              <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>              <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot; :%d %d %d=%d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">q</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">ASSIGNsymbol</span> <span class="p">,</span>
</span><span class='line'>                  <span class="n">list</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">)],</span><span class="n">i</span><span class="p">,</span>
</span><span class='line'>                  <span class="o">!</span><span class="n">hasCommonResults</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">),</span>
</span><span class='line'>                  <span class="o">!</span><span class="n">hasSideEffects</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">),</span>
</span><span class='line'>                  <span class="o">!</span><span class="n">isUpdateInstruction</span><span class="p">(</span><span class="n">q</span><span class="p">),</span>
</span><span class='line'>                  <span class="n">isLinearFlow</span><span class="p">(</span><span class="n">q</span><span class="p">),</span>
</span><span class='line'>                  <span class="n">isLinearFlow</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>              <span class="cm">/*</span>
</span><span class='line'><span class="cm">              * @-</span>
</span><span class='line'><span class="cm">              * Simple assignments are not replaced either. They should be</span>
</span><span class='line'><span class="cm">              * handled by the alias removal part. All arguments should</span>
</span><span class='line'><span class="cm">              * be assigned their value before instruction p.</span>
</span><span class='line'><span class="cm">              */</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span> <span class="n">hasSameArguments</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="n">hasSameSignature</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="o">!</span><span class="n">hasCommonResults</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="o">!</span><span class="n">isUnsafeFunction</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="n">isLinearFlow</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="k">if</span> <span class="p">(</span><span class="n">safetyBarrier</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>                      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#safetybarrier reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>                      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;Found a common expression &quot;</span> <span class="s">&quot;%d &lt;-&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>                  <span class="n">clrFunction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>                      <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">p</span><span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>                  <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;COMMON MODIFIED EXPRESSION %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>                  <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">break</span><span class="p">;</span> <span class="cm">/* end of search */</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">hasSideEffects</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="o">||</span> <span class="n">isUpdateInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">)){</span>
</span><span class='line'>              <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;COMMON SKIPPED %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hasSideEffects</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">,</span> <span class="n">isUpdateInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
</span><span class='line'>              <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_commonTerms: %d statements catched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'><span class="cp">#ifdef DEBUG_OPT_COMMONTERMS_MORE</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_commonTerms: %d statements catched</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>6.常量表达式评估：</p>
<p>由编译器产生只涉及常量的参数的表达式可以被评估一次。它特别是与经常被调用的函数相关。一次的查询不会从这额外的步骤得益。考虑下列的包含重复使用的常量参数的代码片段。</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">a:</span><span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>   <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">b:</span><span class="o">=</span> <span class="mi">2</span><span class="p">;</span>        <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">c:</span><span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">b</span><span class="p">;</span>    <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">d:</span><span class="o">=</span> <span class="n">calc</span><span class="p">.</span><span class="n">flt</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>   <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">e:</span><span class="o">=</span> <span class="n">mmath</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">aliasRemoval</span><span class="p">();</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">evaluate</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>会被转换成代码块</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
</span><span class='line'>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
</span><span class='line'>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="o">-</span><span class="mf">0.279415488</span><span class="p">);</span>
</span><span class='line'><span class="cm">/*同样的我们尝试基于常量捕捉barrier块*/</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote></blockquote>

<figure class='code'><figcaption><span>MonetDB常量表达式优化  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>  <span class="nf">OPTconstantsImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fnd</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">alias</span><span class="p">,</span> <span class="o">*</span><span class="n">index</span><span class="p">;</span>
</span><span class='line'>  <span class="n">VarPtr</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">cst</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">OPTDEBUGconstants</span> <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#OPT_CONSTANTS: MATCHING CONSTANTS ELEMENTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">alias</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="n">cst</span><span class="o">=</span> <span class="p">(</span><span class="n">VarPtr</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">VarPtr</span><span class="p">)</span> <span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="n">index</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">alias</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">cst</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">alias</span><span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">cst</span><span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">cst</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">index</span><span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">alias</span><span class="p">[</span> <span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">isVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="n">isVarFixed</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>          <span class="n">x</span><span class="o">=</span> <span class="n">getVar</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>          <span class="n">fnd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">vtype</span><span class="p">)</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span> <span class="n">k</span><span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">k</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">){</span>
</span><span class='line'>              <span class="n">y</span><span class="o">=</span> <span class="n">cst</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                   <span class="n">x</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">vtype</span> <span class="o">==</span> <span class="n">y</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">vtype</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="n">ATOMcmp</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">vtype</span><span class="p">,</span> <span class="n">VALptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">),</span> <span class="n">VALptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                  <span class="n">OPTDEBUGconstants</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_constants: matching elements %s %d %d &quot;</span><span class="p">,</span> <span class="n">getVarName</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">ATOMprint</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">vtype</span><span class="p">,</span><span class="n">VALptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">),</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="cm">/* re-use a constant */</span>
</span><span class='line'>                  <span class="n">alias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
</span><span class='line'>                  <span class="n">fnd</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">break</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">fnd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>              <span class="n">OPTDEBUGconstants</span> <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;swith elements %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
</span><span class='line'>              <span class="n">cst</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span> <span class="n">x</span><span class="p">;</span>
</span><span class='line'>              <span class="n">index</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>              <span class="n">n</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>      <span class="n">p</span><span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">)];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_constants: %d constant duplicates removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">cst</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>7.代价模型方法:</p>
<p>代价模型是许多优化决定的基础。代价参数经常是（中间的）结果的大小和反应的时间。换言之，它们是运行聚集，如，从模拟运行中得到的最大的内存使用和总共的运行时间。当前的实现包含一个框架和对自身以代价为基础的例子。OPTIMIZER.COSTMODEL（）以自己的方式在MAL程序中运行寻找关系运算和估计它们结果的大小。估计的大小被置后作为属性ROWS。</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">r</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">s</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">1000</span><span class="p">}</span><span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">rs:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">rr:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span><span class="n">rr</span><span class="p">);</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">costModel</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>该表指令的属性如下：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">r</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">s</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">1000</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">rs</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">501</span><span class="p">}</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">rr</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span class='line'>  <span class="n">j</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span><span class="n">rr</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>代价估计在真正的数据分布上未用任何的统计。它依赖于由front-end或其它优化器提供的ROWS属性。它只是使用了一些启发式代价估计器。然而，它保证空的结果会被ROWS=0标记，如果估计是精确的，否则它假设至少一个结果行。这个属性使安全传递代价估计的结果到减少代码的EMPTYSET优化器成为可能。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB代价估计实现代码   </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="cm">/*The cost will be used in many places to make decisions.</span>
</span><span class='line'><span class="cm"> * Access should be fast.</span>
</span><span class='line'><span class="cm"> * The SQL front-end also makes the BAT index available as the</span>
</span><span class='line'><span class="cm"> * property bid. This can be used to access the BAT and involve</span>
</span><span class='line'><span class="cm"> * more properties into the decision procedure.</span>
</span><span class='line'><span class="cm"> * Also make sure you don&#39;t re-use variables, because then the</span>
</span><span class='line'><span class="cm"> * row count becomes non-deterministic.*/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">OPTcostModelImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">wrd</span> <span class="n">k</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">sortrevRef</span><span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;sortReverse&quot;</span><span class="p">,</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">sortrevTailRef</span><span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;sortReverseTail&quot;</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">projectRef</span><span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;project&quot;</span><span class="p">,</span><span class="mi">7</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">inlineProp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="n">algebraRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">markTRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">markHRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">selectNotNilRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sortRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sortTailRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sortrevRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sortrevTailRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">projectRef</span>  <span class="p">){</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">unionRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">kunionRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,(</span><span class="n">c1</span><span class="o">+</span><span class="n">c2</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">kdifferenceRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,(</span><span class="n">c1</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="n">c2</span><span class="o">==</span><span class="mi">0</span><span class="o">?</span><span class="n">c1</span><span class="o">:</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">joinRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">leftjoinRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">leftjoinPathRef</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="cm">/* assume 1-1 joins */</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,(</span><span class="n">c1</span> <span class="o">&lt;</span> <span class="n">c2</span> <span class="o">?</span> <span class="n">c1</span> <span class="o">:</span> <span class="n">c2</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">semijoinRef</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="cm">/* assume 1-1 semijoins */</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,(</span><span class="n">c1</span> <span class="o">&lt;</span> <span class="n">c2</span><span class="o">?</span> <span class="n">c1</span> <span class="o">:</span> <span class="n">c2</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">selectRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">uselectRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">thetaselectRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">thetauselectRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">c1</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">?</span> <span class="n">c1</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="o">:</span> <span class="n">c1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">crossRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,((</span><span class="n">log</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">c1</span><span class="p">)</span> <span class="o">+</span> <span class="n">log</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">c2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">log</span><span class="p">(</span><span class="n">INT_MAX</span><span class="p">)</span> <span class="o">?</span> <span class="n">INT_MAX</span> <span class="o">:</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">c2</span> <span class="o">+</span><span class="mi">1</span><span class="p">)),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">tuniqueRef</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span> <span class="n">c1</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="n">c1</span> <span class="o">:</span> <span class="n">c1</span> <span class="o">/</span> <span class="mi">10</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">batcalcRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">ifthenelseRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">){</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">batstrRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">batRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">reverseRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">setWriteModeRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">hashRef</span>  <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">mirrorRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">appendRef</span> <span class="o">||</span>
</span><span class='line'>                 <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">insertRef</span> <span class="p">){</span>
</span><span class='line'>              <span class="cm">/*</span>
</span><span class='line'><span class="cm">              * Updates are a little more complicated, because you have to</span>
</span><span class='line'><span class="cm">              * propagate changes in the expected size up the expression tree.</span>
</span><span class='line'><span class="cm">              * For example, the SQL snippet:</span>
</span><span class='line'><span class="cm">              *     _49:bat[:oid,:oid]{rows=0,bid=622}  := sql.bind_dbat(&quot;sys&quot;,&quot;example&quot;,3);</span>
</span><span class='line'><span class="cm">              *     _54 := bat.setWriteMode(_49);</span>
</span><span class='line'><span class="cm">              *     bat.append(_54,_47,true);</span>
</span><span class='line'><span class="cm">              * shows what is produced when it encounters a deletion. If a non-empty</span>
</span><span class='line'><span class="cm">              * append is not properly passed back to _49, the emptySet</span>
</span><span class='line'><span class="cm">              * optimizer might remove the complete deletion code.</span>
</span><span class='line'><span class="cm">              * The same holds for replacement operations, which add information to</span>
</span><span class='line'><span class="cm">              * an initially empty insertion BAT.</span>
</span><span class='line'><span class="cm">              */</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">){</span>
</span><span class='line'>                  <span class="cm">/* insert BAT */</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">OPTbackpropagate</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="cm">/* insert scalars */</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">c1</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">OPTbackpropagate</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">deleteRef</span><span class="p">){</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">){</span>
</span><span class='line'>                  <span class="cm">/* delete BAT */</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c2</span> <span class="o">==</span><span class="mi">0</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">OPTbackpropagate</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="cm">/* insert scalars */</span>
</span><span class='line'>                  <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">c1</span><span class="o">==</span><span class="mi">1</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span> <span class="n">c1</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">OPTbackpropagate</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="n">OPTbackpropagate</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">insertRef</span><span class="p">){</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span> <span class="n">c1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* faked */</span>
</span><span class='line'>              <span class="n">OPTbackpropagate</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="n">groupRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span><span class="n">newRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span> <span class="n">c1</span> <span class="o">/</span> <span class="mi">10</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">aggrRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sumRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">minRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">maxRef</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">avgRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span> <span class="n">c1</span><span class="o">?</span><span class="n">c1</span><span class="o">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span> <span class="k">else</span>    <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">countRef</span><span class="p">){</span>
</span><span class='line'>              <span class="n">newRows</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ASSIGNsymbol</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
</span><span class='line'>          <span class="cm">/* copy the rows property */</span>
</span><span class='line'>          <span class="n">c1</span> <span class="o">=</span> <span class="n">getVarRows</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">c1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">ValRecord</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>              
</span><span class='line'>              <span class="n">varSetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">rowsProp</span><span class="p">,</span> <span class="n">op_eq</span><span class="p">,</span> <span class="n">VALset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="n">TYPE_wrd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">));</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_costModel: processed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>8.数据流优化器 ：</p>
<p>MAL程序很大程度上是执行计划的逻辑描述。至少它关注没有副影响的操作。对于这些子计划执行的顺序需要的不是一个固定的优先级而可能是数据流驱动的评估。甚至使用多核互不影响地工作在数据流图中。数据流优化器分析代码和为了数据流驱动执行用保护块包装健壮的代码。当然，这只是必要的如果你可以前端决定可能有多线程的运行。</p>
<p>对于运行，解析器根据可用处理器核的数量来初始化多线程。接下来，合格的指令被排序和被解析器线程解析。数据流块可能不是成堆的。因此，为内联代码产生的任何数据流块首先被去除。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB数据流优化器实现代码  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">OPTdataflowImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">entries</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">flowblock</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dumbcopy</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Lifespan</span> <span class="n">span</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* don&#39;t use dataflow on single processor systems */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">GDKnr_threads</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="cm">/* inlined functions will get their dataflow control later */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">0</span><span class="p">),</span><span class="n">inlineProp</span><span class="p">)</span><span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">span</span><span class="o">=</span> <span class="n">setLifespan</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">span</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">init</span><span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">init</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">limit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">slimit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">;</span>
</span><span class='line'>  <span class="n">old</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="o">+</span><span class="mi">20</span><span class="p">)</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">removeDataflow</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">limit</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* inject new dataflow barriers */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ENDsymbol</span><span class="p">)</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">hasSideEffects</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">FALSE</span><span class="p">)</span> <span class="o">||</span> <span class="n">isUnsafeFunction</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">||</span> <span class="n">blockCntrl</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">dumbcopy</span> <span class="o">&amp;&amp;</span> <span class="n">blockExit</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sqlRef</span> <span class="o">&amp;&amp;</span> <span class="n">isUpdateInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">||</span> <span class="n">dflowAssignTest</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>          <span class="cm">/* close old flow block */</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">flowblock</span><span class="p">){</span>
</span><span class='line'>              <span class="kt">int</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">simpleFlow</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sf</span> <span class="o">&amp;&amp;</span> <span class="n">entries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>                  <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">start</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>                      <span class="k">for</span><span class="p">(</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                      <span class="k">if</span><span class="p">(</span> <span class="n">getBeginLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">init</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                          <span class="n">InstrPtr</span> <span class="n">r</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>                          <span class="n">getArg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                          <span class="n">pushNil</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                          <span class="n">init</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                      <span class="p">}</span>
</span><span class='line'>                  <span class="n">q</span><span class="o">=</span> <span class="n">newFcnCall</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">languageRef</span><span class="p">,</span><span class="n">dataflowRef</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">q</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">=</span> <span class="n">BARRIERsymbol</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">flowblock</span><span class="p">;</span>
</span><span class='line'>                  <span class="cm">/* dataflow blocks are transparent, because they are always</span>
</span><span class='line'><span class="cm">                    executed, either sequentially or in parallell */</span>
</span><span class='line'>                  <span class="n">varSetProperty</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;transparent&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">start</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>                      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sf</span> <span class="o">&amp;&amp;</span> <span class="n">entries</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>                  <span class="n">q</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">q</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">=</span> <span class="n">EXITsymbol</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">flowblock</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>              <span class="n">flowblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>              <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">blockStart</span><span class="p">(</span><span class="n">p</span><span class="p">)){</span>
</span><span class='line'>          <span class="n">dumbcopy</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">dumbcopy</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>              <span class="cm">/* close old flow block */</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">flowblock</span><span class="p">){</span>
</span><span class='line'>                  <span class="kt">int</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">simpleFlow</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sf</span> <span class="o">&amp;&amp;</span> <span class="n">entries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>                      <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">start</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                      <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>                          <span class="k">for</span><span class="p">(</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                          <span class="k">if</span><span class="p">(</span> <span class="n">getBeginLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">init</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                              <span class="n">InstrPtr</span> <span class="n">r</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>                              <span class="n">getArg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                              <span class="n">pushNil</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                              <span class="n">init</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                          <span class="p">}</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">=</span> <span class="n">newFcnCall</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">languageRef</span><span class="p">,</span><span class="n">dataflowRef</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">=</span> <span class="n">BARRIERsymbol</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">flowblock</span><span class="p">;</span>
</span><span class='line'>                      <span class="cm">/* dataflow blocks are transparent, because they are always</span>
</span><span class='line'><span class="cm">                        executed, either sequentially or in parallell */</span>
</span><span class='line'>                      <span class="n">varSetProperty</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;transparent&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">start</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                      <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>                          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sf</span> <span class="o">&amp;&amp;</span> <span class="n">entries</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">=</span> <span class="n">EXITsymbol</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">flowblock</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">flowblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">blockExit</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">assert</span><span class="p">(</span><span class="n">flowblock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="n">dumbcopy</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">dumbcopy</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">assert</span><span class="p">(</span><span class="n">flowblock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">flowblock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span><span class='line'>          <span class="n">flowblock</span> <span class="o">=</span> <span class="n">newTmpVariable</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">TYPE_bit</span><span class="p">);</span>
</span><span class='line'>          <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>          <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="cm">/* check if the instruction can start a flow */</span>
</span><span class='line'>      <span class="cm">/* this should be a function call with multiple arguments */</span>
</span><span class='line'>      <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span> <span class="n">isVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">))</span> <span class="o">||</span> <span class="n">getLastUpdate</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">start</span><span class="p">)</span>
</span><span class='line'>                  <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">dflowAssignTest</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
</span><span class='line'>          <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">==</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">)</span>
</span><span class='line'>          <span class="n">entries</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cm">/* close old flow block */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">flowblock</span><span class="p">){</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">simpleFlow</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sf</span> <span class="o">&amp;&amp;</span> <span class="n">entries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">start</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>              <span class="k">for</span><span class="p">(</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">getBeginLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">init</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
</span><span class='line'>                  <span class="n">InstrPtr</span> <span class="n">r</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">getArg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">pushNil</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                  <span class="n">init</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">k</span><span class="p">)]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="n">q</span><span class="o">=</span> <span class="n">newFcnCall</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">languageRef</span><span class="p">,</span><span class="n">dataflowRef</span><span class="p">);</span>
</span><span class='line'>          <span class="n">q</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">=</span> <span class="n">BARRIERsymbol</span><span class="p">;</span>
</span><span class='line'>          <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span> <span class="n">flowblock</span><span class="p">;</span>
</span><span class='line'>          <span class="cm">/* dataflow blocks are transparent, because they are always</span>
</span><span class='line'><span class="cm">            executed, either sequentially or in parallell */</span>
</span><span class='line'>          <span class="n">varSetProperty</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;transparent&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">start</span> <span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span><span class='line'>              <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sf</span> <span class="o">&amp;&amp;</span> <span class="n">entries</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">){</span>
</span><span class='line'>          <span class="n">q</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>          <span class="n">q</span><span class="o">-&gt;</span><span class="n">barrier</span><span class="o">=</span> <span class="n">EXITsymbol</span><span class="p">;</span>
</span><span class='line'>          <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">flowblock</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">flowblock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cm">/* take the remainder as is */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_dataflow: %d flow blocks created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>9.去除无用代码</p>
<p>无用代码碎片通过赋值到不再使用的变量被识别。它可以被探测通过标记作为使用的参数作为相关的所有的变量。同时，我们建立应该在最后结果出现的一系列指令。新建的代码块在一次扫描中建立，去除无用的指令。指令对环境产生副影响，如，输出和更新BAT应该被考虑进来。这样（可能递归）函数应该被标记有一个（不安全）的属性。现在我们识别了几个重要的，否则，指令被标记为控制流指令应该被保留。一个说明性例子的MAL片段如下：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">V7</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V10</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V16</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">markH</span><span class="p">(</span><span class="n">V7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V17</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">V16</span><span class="p">,</span><span class="n">V7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V19</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V22</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V23</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">V16</span><span class="p">,</span><span class="n">V22</span><span class="p">);</span>
</span><span class='line'>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">deadCodeRemoval</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>去除无用的代码使程序缩小到一下的短小的代码块：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;done&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>对无用代码的提炼来源与使用停止存在的参数因为行为被优化器做了。如，在下面的代码片段PUSHRANGES优化器可能得出变量V31变为空的和简单地通过去掉赋值语句注入一个‘无用’变量。这同时使其他代码无用。</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">V30</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span> <span class="n">V7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V31</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">V30</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V32</span> <span class="o">:=</span> <span class="n">aggr</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V31</span><span class="p">);</span>
</span><span class='line'>  <span class="n">io</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">V32</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote></blockquote>

<figure class='code'><figcaption><span>MonetDB去除无用的代码实现  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">OPTdeadcodeImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span> <span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>     <span class="cm">/* to fool compilers */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">inlineProp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">clrDeclarations</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="n">chkDeclarations</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="n">limit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">slimit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span><span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">se</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ENDsymbol</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">se</span><span class="p">){</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>                  <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">!=</span> <span class="n">NOOPsymbol</span><span class="p">)</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span> <span class="n">isVarUsed</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">){</span>
</span><span class='line'>              <span class="n">se</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>              <span class="k">break</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">NOOPsymbol</span><span class="p">){</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">sqlRef</span> <span class="o">&amp;&amp;</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">assertRef</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="n">isVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">ival</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">se</span> <span class="o">||</span> <span class="n">hasSideEffects</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">||</span> <span class="n">isUpdateInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">isLinearFlow</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">isProcedure</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>  <span class="o">||</span>
</span><span class='line'>              <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">varGetProp</span><span class="p">(</span> <span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">unsafeProp</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>              <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="cm">/* ==side-effect */</span><span class="p">)</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_deadcode: %d statements removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="cm">/* we may have uncovered new use-less operations */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">actions</span><span class="p">)</span>
</span><span class='line'>      <span class="n">actions</span> <span class="o">+=</span> <span class="n">OPTdeadcodeImplementation</span><span class="p">(</span><span class="n">cntxt</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span> <span class="n">stk</span><span class="p">,</span> <span class="n">pci</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>10.去除空集：</p>
<p>在MAL优化期间其中最关键决定是估计产生和消耗的BAT的大小。两种情况对标志处理有兴趣。也就是，当一个BAT被知道没有包含元组和元组只有一个元素。这样的信息可能来自应用领域只是或者作为从标志评估另外的影响。这关联到作为属性被探测的程序。空集属性被呈现的消减算法使用。任何空集在程序中被传播到达一个更小和因此更快的评估。如，考虑接下来的MAL测试：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">V1</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V7</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V10</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V11</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">V10</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V12</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">kdifference</span><span class="p">(</span><span class="n">V7</span><span class="p">,</span><span class="n">V11</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V16</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">markH</span><span class="p">(</span><span class="n">V12</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V17</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">V16</span><span class="p">,</span><span class="n">V7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">V1</span><span class="p">,</span><span class="n">V17</span><span class="p">);</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">costModel</span><span class="p">();</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">emptySet</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>调用优化器用接下来的程序片段取代上面的程序</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">V1</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V7</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V10</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="kt">int</span><span class="p">,</span><span class="o">:</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V11</span><span class="p">{</span><span class="n">rows</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V12</span> <span class="o">:=</span> <span class="n">V7</span><span class="p">;</span>
</span><span class='line'>  <span class="n">V16</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">markH</span><span class="p">(</span><span class="n">V12</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V17</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">V16</span><span class="p">,</span><span class="n">V7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">V1</span><span class="p">,</span><span class="n">V17</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>这代码块可以使用别名传播和去除无用代码继续优化。最后的代码块如下：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">V1</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V7</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V16</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">markH</span><span class="p">(</span><span class="n">V7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">V17</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">V16</span><span class="p">,</span><span class="n">V7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">V1</span><span class="p">,</span><span class="n">V17</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>在空集传播时，新的候选者可能出现。如，与空集进行交运算还是得到空集。它成为中间优化的目标。当前的实现是保守的。一个有限的指令集合被考虑。任何添加到MonetDB指令集调用评估它们的影响。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB去除空集的代码实现  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>  <span class="nf">ESevaluate</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">empty</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">existRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;exist&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">uniqueRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;unique&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">suniqueRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;sunique&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">intersectRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;intersect&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">sintersectRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;sintersect&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">kintersectRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;kintersect&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">fragmentRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;fragment&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">runonce</span><span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="n">slimit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">,</span> <span class="n">ctop</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">,</span> <span class="o">*</span><span class="n">constraints</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="cm">/* get query property */</span>
</span><span class='line'>  <span class="n">runonce</span> <span class="o">=</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">runonceProp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">inlineProp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">constraints</span><span class="o">=</span> <span class="p">(</span><span class="n">InstrPtr</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDKmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">InstrPtr</span><span class="p">)</span><span class="o">*</span><span class="n">slimit</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">constraints</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">);</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">alias</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span> <span class="n">alias</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">);</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
</span><span class='line'>      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span> <span class="o">=</span> <span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">constraints</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">alias</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Symbolic evaluation of the empty BAT variables */</span>
</span><span class='line'>  <span class="cm">/* by looking at empty BAT arguments */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ENDsymbol</span><span class="p">){</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>                  <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="n">p</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)];</span>
</span><span class='line'>      <span class="cm">/*</span>
</span><span class='line'><span class="cm">          * The bulk of the intelligence lies in inspecting calling</span>
</span><span class='line'><span class="cm">          * sequences to filter and replace calls with empty arguments.</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>      <span class="n">f</span> <span class="o">=</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">sqlRef</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="n">empty</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>         <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="n">bindRef</span> <span class="o">||</span> <span class="n">f</span> <span class="o">==</span> <span class="n">bindidxRef</span> <span class="o">||</span> <span class="n">f</span> <span class="o">==</span> <span class="n">binddbatRef</span><span class="p">)){</span>
</span><span class='line'>          <span class="n">InstrPtr</span> <span class="n">q</span><span class="p">;</span>
</span><span class='line'>          <span class="cm">/*</span>
</span><span class='line'><span class="cm">          * @-</span>
</span><span class='line'><span class="cm">          * The emptyset assertion is only needed once for relational insertions.</span>
</span><span class='line'><span class="cm">          * We assume here that string constants have been matched already.</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span> <span class="n">f</span> <span class="o">==</span> <span class="n">bindRef</span> <span class="o">&amp;&amp;</span> <span class="n">runonce</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">for</span><span class="p">(</span> <span class="n">j</span><span class="o">=</span><span class="n">ctop</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">){</span>
</span><span class='line'>                  <span class="n">q</span><span class="o">=</span> <span class="n">constraints</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span><span class='line'>                  <span class="k">if</span><span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">2</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">sval</span><span class="p">,</span> <span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">sval</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                      <span class="n">strcmp</span><span class="p">(</span><span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">3</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">sval</span><span class="p">,</span> <span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">sval</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                      <span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">5</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">ival</span><span class="o">&lt;=</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="cm">/* no updates etc */</span>
</span><span class='line'>                      <span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">5</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">ival</span> <span class="o">==</span> <span class="n">getVarConstant</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">5</span><span class="p">)).</span><span class="n">val</span><span class="p">.</span><span class="n">ival</span>
</span><span class='line'>                  <span class="p">)</span>
</span><span class='line'>                      <span class="cm">/* don&#39;t generate the assertion */</span>
</span><span class='line'>                      <span class="k">goto</span> <span class="n">ignoreConstraint</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">q</span> <span class="o">=</span> <span class="n">newStmt1</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">constraintsRef</span><span class="p">,</span> <span class="s">&quot;emptySet&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
</span><span class='line'>              <span class="n">constraints</span><span class="p">[</span><span class="n">ctop</span><span class="o">++</span><span class="p">]</span><span class="o">=</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="nl">ignoreConstraint:</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">empty</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">j</span><span class="p">)])</span> <span class="p">{</span>
</span><span class='line'>              <span class="cm">/* decode operations */</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">algebraRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="n">existRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="cm">/* always false */</span>
</span><span class='line'>                      <span class="n">setModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">setFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">=</span> <span class="n">ASSIGNsymbol</span><span class="p">;</span>
</span><span class='line'>                      <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pushBit</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span> <span class="n">f</span> <span class="o">==</span> <span class="n">selectRef</span> <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">tuniqueRef</span> <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">likeRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">sortRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">sortTailRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">sortHTRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">sortTHRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">uniqueRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">suniqueRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">kuniqueRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">intersectRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">semijoinRef</span> <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">sintersectRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">kintersectRef</span>  <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">fragmentRef</span> <span class="p">){</span>
</span><span class='line'>
</span><span class='line'>                      <span class="cm">/* result is empty */</span>
</span><span class='line'>                      <span class="n">propagate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span> <span class="n">f</span> <span class="o">==</span> <span class="n">differenceRef</span> <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">kdifferenceRef</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">propagate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span> <span class="n">f</span> <span class="o">==</span> <span class="n">sunionRef</span> <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">kunionRef</span> <span class="o">||</span>
</span><span class='line'>                       <span class="n">f</span> <span class="o">==</span> <span class="n">unionRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                      <span class="cm">/* copy non-empty argument */</span>
</span><span class='line'>                      <span class="k">if</span><span class="p">(</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                          <span class="n">propagate</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>                      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                          <span class="n">propagate</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>                      <span class="p">}</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">batRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(</span> <span class="n">f</span> <span class="o">==</span> <span class="n">reverseRef</span> <span class="o">||</span> <span class="n">f</span> <span class="o">==</span> <span class="n">mirrorRef</span> <span class="p">){</span>
</span><span class='line'>                      <span class="n">empty</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="cm">/*</span>
</span><span class='line'><span class="cm">              * @-</span>
</span><span class='line'><span class="cm">              * If the target variable is empty and the function does not</span>
</span><span class='line'><span class="cm">              * have a side-effect, we can replace it with a construction</span>
</span><span class='line'><span class="cm">              * of the empty set. The dead-code optimizer will take care</span>
</span><span class='line'><span class="cm">              * of removal of superflous constructions.</span>
</span><span class='line'><span class="cm">              */</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ASSIGNsymbol</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="o">!</span><span class="n">isLinearFlow</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">))){</span>
</span><span class='line'>                  <span class="kt">int</span> <span class="n">tpe</span><span class="o">=</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">clrFunction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">setModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">batRef</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">setFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">newRef</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">p</span><span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">newTypeVariable</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getHeadType</span><span class="p">(</span><span class="n">tpe</span><span class="p">)));</span>
</span><span class='line'>                  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">newTypeVariable</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getTailType</span><span class="p">(</span><span class="n">tpe</span><span class="p">)));</span>
</span><span class='line'>                  <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">break</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">actions</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_emptyset: %d empty sets statements removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>      <span class="n">clrAllTypes</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>     <span class="cm">/* force a complete resolve */</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">constraints</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">alias</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'> <span class="cm">/*We first have to find all candidates for empty set removal.</span>
</span><span class='line'><span class="cm">  They are recognized by an estimated zero row count and they</span>
</span><span class='line'><span class="cm">  are not the target of an update.*/</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">OPTemptySetImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">empty</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">empty</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">vsize</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">empty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">getVarRows</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">OPTDEBUGemptySet</span>
</span><span class='line'>              <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;#START emptyset optimizer %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>          <span class="n">empty</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">OPTDEBUGemptySet</span> <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">i</span><span class="o">=</span> <span class="n">ESevaluate</span><span class="p">(</span><span class="n">cntxt</span><span class="p">,</span> <span class="n">mb</span><span class="p">,</span> <span class="n">empty</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">empty</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>11.垃圾回收：</p>
<p>对临时的变量的垃圾回收，如字符串和BATs，在返回函数调用的时候发生。特别对于BATs这可能保留可观的资源锁定长于严格必要的时间。尽管程序员可以影响它们的生命周期通过给它们赋值NIL，从而触发垃圾会后，依靠优化器去注入这样的语句更加恰当。因为它使程序更加短小和有一个更好的代码优化的目标。OPTIMIZER.GARBAGECOLLECTOR()操作去除所有结束生命周期的BAT为新的提供空间。这特别被调用为优化的最后一步。垃圾回收影响的一小段代码：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">t1</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t2</span> <span class="o">:=</span> <span class="n">array</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">132000</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t3</span> <span class="o">:=</span> <span class="n">array</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10560</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t4</span> <span class="o">:=</span> <span class="n">array</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10560</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t5</span> <span class="o">:=</span> <span class="n">batcalc</span><span class="p">.</span><span class="o">+</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t6</span> <span class="o">:=</span> <span class="n">batcalc</span><span class="p">.</span><span class="n">oid</span><span class="p">(</span><span class="n">t5</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t7</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">optimizer</span><span class="p">.</span><span class="n">garbageCollector</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>被转换为以下的代码块</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="n">t1</span> <span class="o">:=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t2</span> <span class="o">:=</span> <span class="n">array</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">132000</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t3</span> <span class="o">:=</span> <span class="n">array</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10560</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t4</span> <span class="o">:=</span> <span class="n">array</span><span class="p">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">10560</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t5</span> <span class="o">:=</span> <span class="n">batcalc</span><span class="p">.</span><span class="o">+</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t4</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">setGarbage</span><span class="p">(</span><span class="n">t2</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">setGarbage</span><span class="p">(</span><span class="n">t4</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t6</span> <span class="o">:=</span> <span class="n">batcalc</span><span class="p">.</span><span class="n">oid</span><span class="p">(</span><span class="n">t5</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">setGarbage</span><span class="p">(</span><span class="n">t5</span><span class="p">);</span>
</span><span class='line'>  <span class="n">t7</span> <span class="o">:=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">t6</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">setGarbage</span><span class="p">(</span><span class="n">t6</span><span class="p">);</span>
</span><span class='line'>  <span class="n">bat</span><span class="p">.</span><span class="n">setGarbage</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>当前的算法是直接的。在每一条指令后，我们检查在未来其BAT参数是否需要。如果不需要，我们注入垃圾回收语句去释放她们呢，如果没有其它理由去保留它。这应该小心地去做，因为指令可能是循环的一部分。如果变量在循环里定义，那么我们可以安全地去掉它。</p></p></blockquote>

<figure class='code'><figcaption><span>MonetDB垃圾回收代码实现   </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="cm">/*Keeping variables around beyond their end-of-life-span</span>
</span><span class='line'><span class="cm"> can be marked with the proper &#39;keep&#39;.*/</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">OPTgarbageCollectorImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">pci</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">vlimit</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">actions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Lifespan</span> <span class="n">span</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">pci</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">inlineProp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">span</span> <span class="o">=</span> <span class="n">setLifespan</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">span</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">old</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>  <span class="n">limit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">slimit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">;</span>
</span><span class='line'>  <span class="n">vlimit</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">p</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>      <span class="n">p</span><span class="o">-&gt;</span><span class="n">gc</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">GARBAGECONTROL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">barrier</span> <span class="o">==</span> <span class="n">RETURNsymbol</span><span class="p">){</span>
</span><span class='line'>          <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">blockStart</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">)</span>
</span><span class='line'>          <span class="n">depth</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ENDsymbol</span><span class="p">)</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="n">n</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">isaBatType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="p">){</span>
</span><span class='line'>              <span class="n">mb</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span><span class="o">-&gt;</span><span class="n">eolife</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
</span><span class='line'>              <span class="n">p</span><span class="o">-&gt;</span><span class="n">gc</span> <span class="o">|=</span> <span class="n">GARBAGECONTROL</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">blockExit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>          <span class="cm">/* force garbage collection of all within upper block */</span>
</span><span class='line'>          <span class="n">depth</span><span class="o">--</span><span class="p">;</span>
</span><span class='line'>          <span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">vlimit</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">i</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="n">isaBatType</span><span class="p">(</span><span class="n">getVarType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                  <span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">keepProp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">=</span> <span class="n">newAssignment</span><span class="p">(</span><span class="n">mb</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">setVarUDFtype</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">setVarFixed</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">k</span><span class="p">);</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">=</span> <span class="n">pushNil</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span> <span class="n">getVarType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                      <span class="n">q</span><span class="o">-&gt;</span><span class="n">gc</span> <span class="o">|=</span> <span class="n">GARBAGECONTROL</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">mb</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">eolife</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                      <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">assert</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>  <span class="n">assert</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span> <span class="o">==</span> <span class="n">ENDsymbol</span><span class="p">);</span>
</span><span class='line'>  <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gc</span> <span class="o">|=</span> <span class="n">GARBAGECONTROL</span><span class="p">;</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">OPTDEBUGgarbageCollector</span><span class="p">{</span>
</span><span class='line'>      <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;#Garbage collected BAT variables </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">for</span> <span class="p">(</span> <span class="n">k</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">vlimit</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;%10s eolife %3d  begin %3d lastupd %3d end %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="n">getVarName</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">eolife</span><span class="p">,</span>
</span><span class='line'>          <span class="n">getBeginLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">getLastUpdate</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="n">getEndLifespan</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="s">&quot;End of GCoptimizer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">span</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_garbagecollector: %d variables reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>13.连接路径：</p>
<p>任务OPTIMIZER.JOINPATH()浏览代码寻找连接操作和级联它们到多连接路径。为了说明，考虑：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">a:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">b:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">c:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j2:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">j1</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j3:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j4:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">j3</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>优化器首先会通过它们连接的顺序替代所有的参数。下面的指令留给去除无用代码优化器优化</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">a:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="o">:</span><span class="n">oid</span><span class="p">,</span><span class="o">:</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j2:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">joinPath</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j3:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j4:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">joinPath</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>在原则上，连接路径可能包含改善性能的公共的子路径。SQL front-end 经常产生以下代码片段：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">t1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">z1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">t1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="nl">t2:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">z2:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">t2</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>连接路径合并成：</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">z1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">joinPath</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="nl">z2:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">joinPath</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>由启发式寻找最先的两个参数控制和重用实质的连接</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">_13:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">z1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">_13</span><span class="p">,</span><span class="n">c</span><span class="p">);</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="nl">z2:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">_13</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>一个替代是公共重新使用的路径重识别到连接路径主体继承的部分</p></p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="nl">x3:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">r3:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">x3</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j1:</span><span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">r3</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">rb:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">ra:</span><span class="o">=</span> <span class="n">bat</span><span class="p">.</span><span class="n">reverse</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>  <span class="nl">j1:</span><span class="o">=</span> <span class="n">algebra</span><span class="p">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">rb</span><span class="p">,</span><span class="n">ra</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote></blockquote>

<figure class='code'><figcaption><span>MonetDB连接路径优化代码的实现  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">OPTjoinPathImplementation</span><span class="p">(</span><span class="n">Client</span> <span class="n">cntxt</span><span class="p">,</span> <span class="n">MalBlkPtr</span> <span class="n">mb</span><span class="p">,</span> <span class="n">MalStkPtr</span> <span class="n">stk</span><span class="p">,</span> <span class="n">InstrPtr</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">pc</span><span class="p">;</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">joinPathRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;joinPath&quot;</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">leftjoinPathRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;leftjoinPath&quot;</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
</span><span class='line'>  <span class="n">str</span> <span class="n">semijoinPathRef</span> <span class="o">=</span> <span class="n">putName</span><span class="p">(</span><span class="s">&quot;semijoinPath&quot;</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="n">q</span><span class="p">,</span><span class="n">r</span><span class="p">;</span>
</span><span class='line'>  <span class="n">InstrPtr</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="o">*</span><span class="n">varcnt</span><span class="p">;</span>       <span class="cm">/* use count */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span><span class="n">slimit</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cntxt</span><span class="p">;</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">stk</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">varGetProp</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">inlineProp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">old</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stmt</span><span class="p">;</span>
</span><span class='line'>  <span class="n">limit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">;</span>
</span><span class='line'>  <span class="n">slimit</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span> <span class="n">newMalBlkStmt</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ssize</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* beware, new variables and instructions are introduced */</span>
</span><span class='line'>  <span class="n">pc</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* to find last assignment */</span>
</span><span class='line'>  <span class="n">varcnt</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="n">GDKzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">vtop</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">varcnt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">varcnt</span> <span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">varcnt</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * @-</span>
</span><span class='line'><span class="cm">  * Count the variable use as arguments first.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>      <span class="n">p</span><span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="n">varcnt</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>      <span class="n">p</span><span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span> <span class="n">getModuleId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">algebraRef</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span> <span class="n">joinRef</span> <span class="o">||</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">leftjoinRef</span> <span class="o">||</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">semijoinRef</span><span class="p">)){</span>
</span><span class='line'>          <span class="cm">/*</span>
</span><span class='line'><span class="cm">          * @-</span>
</span><span class='line'><span class="cm">          * Try to expand its argument list with what we have found so far.</span>
</span><span class='line'><span class="cm">          * This creates a series of join paths, many of which will be removed during deadcode elimination.</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>          <span class="n">q</span><span class="o">=</span> <span class="n">copyInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>              <span class="n">r</span><span class="o">=</span> <span class="n">getInstrPtr</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">pc</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)]);</span>
</span><span class='line'>              <span class="cm">/*</span>
</span><span class='line'><span class="cm">              * @-</span>
</span><span class='line'><span class="cm">              * Don&#39;t inject a pattern when it is used more than once.</span>
</span><span class='line'><span class="cm">              */</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">varcnt</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>                  <span class="n">OPTDEBUGjoinPath</span> <span class="p">{</span>
</span><span class='line'>                      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#double use %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">varcnt</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)]);</span>
</span><span class='line'>                      <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="n">OPTDEBUGjoinPath</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#expand list </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">joinRef</span><span class="p">){</span>
</span><span class='line'>                  <span class="k">if</span><span class="p">(</span> <span class="n">r</span> <span class="o">&amp;&amp;</span>  <span class="n">getModuleId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">algebraRef</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">joinRef</span>  <span class="o">||</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">joinPathRef</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>                      <span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                          <span class="n">q</span> <span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                  <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>                      <span class="n">q</span> <span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">leftjoinRef</span><span class="p">){</span>
</span><span class='line'>                  <span class="k">if</span><span class="p">(</span> <span class="n">r</span> <span class="o">&amp;&amp;</span>  <span class="n">getModuleId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">algebraRef</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">leftjoinRef</span>  <span class="o">||</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">leftjoinPathRef</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>                      <span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                          <span class="n">q</span> <span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                  <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>                      <span class="n">q</span> <span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">semijoinRef</span><span class="p">){</span>
</span><span class='line'>                  <span class="k">if</span><span class="p">(</span> <span class="n">r</span> <span class="o">&amp;&amp;</span>  <span class="n">getModuleId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">algebraRef</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">semijoinRef</span>  <span class="o">||</span> <span class="n">getFunctionId</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span> <span class="n">semijoinPathRef</span><span class="p">)</span> <span class="p">){</span>
</span><span class='line'>                      <span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>                          <span class="n">q</span> <span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">));</span>
</span><span class='line'>                  <span class="p">}</span> <span class="k">else</span>
</span><span class='line'>                      <span class="n">q</span> <span class="o">=</span> <span class="n">pushArgument</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="n">OPTDEBUGjoinPath</span> <span class="p">{</span>
</span><span class='line'>              <span class="n">chkTypes</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span> <span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">nspace</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">TRUE</span><span class="p">);</span>
</span><span class='line'>              <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#new [left]joinPath instruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="n">printInstruction</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">LIST_MAL_ALL</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">&lt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">){</span>
</span><span class='line'>              <span class="cm">/* no change */</span>
</span><span class='line'>              <span class="n">freeInstruction</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span><span class='line'>              <span class="k">goto</span> <span class="n">wrapup</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="cm">/*</span>
</span><span class='line'><span class="cm">          * @-</span>
</span><span class='line'><span class="cm">          * Final type check and hardwire the result type, because that  can not be inferred directly from the signature</span>
</span><span class='line'><span class="cm">          */</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span> <span class="n">getTailType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">))</span> <span class="o">!=</span> <span class="n">getHeadType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="o">!</span><span class="p">(</span> <span class="n">getTailType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">==</span> <span class="n">TYPE_oid</span>  <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="n">getHeadType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">==</span> <span class="n">TYPE_void</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="o">!</span><span class="p">(</span> <span class="n">getTailType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">==</span> <span class="n">TYPE_void</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>              <span class="n">getHeadType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">==</span> <span class="n">TYPE_oid</span><span class="p">)){</span>
</span><span class='line'>              <span class="cm">/* don&#39;t use it */</span>
</span><span class='line'>                  <span class="n">freeInstruction</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">goto</span> <span class="n">wrapup</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="cm">/* fix the type */</span>
</span><span class='line'>          <span class="n">setVarUDFtype</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
</span><span class='line'>          <span class="n">setVarType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">getArg</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">newBatType</span><span class="p">(</span> <span class="n">getHeadType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">)),</span> <span class="n">getTailType</span><span class="p">(</span><span class="n">getArgType</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">-</span><span class="mi">1</span><span class="p">))));</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">3</span>  <span class="o">&amp;&amp;</span>  <span class="n">getFunctionId</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">joinRef</span><span class="p">)</span>
</span><span class='line'>              <span class="n">setFunctionId</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">joinPathRef</span><span class="p">);</span>
</span><span class='line'>          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">3</span>  <span class="o">&amp;&amp;</span>  <span class="n">getFunctionId</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">leftjoinRef</span><span class="p">)</span>
</span><span class='line'>              <span class="n">setFunctionId</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">leftjoinPathRef</span><span class="p">);</span>
</span><span class='line'>          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span>  <span class="o">&amp;&amp;</span>  <span class="n">getFunctionId</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">semijoinRef</span><span class="p">)</span>
</span><span class='line'>              <span class="n">setFunctionId</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">semijoinPathRef</span><span class="p">);</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>          <span class="n">p</span><span class="o">=</span> <span class="n">q</span><span class="p">;</span>
</span><span class='line'>          <span class="n">actions</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="n">wrapup</span><span class="o">:</span>
</span><span class='line'>      <span class="n">pushInstruction</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>          <span class="n">pc</span><span class="p">[</span><span class="n">getArg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">j</span><span class="p">)]</span><span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">stop</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">slimit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span class='line'>          <span class="n">freeInstruction</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="cm">/* perform the second phase, try out */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">actions</span> <span class="p">)</span>
</span><span class='line'>      <span class="n">actions</span> <span class="o">+=</span> <span class="n">OPTjoinSubPath</span><span class="p">(</span><span class="n">cntxt</span><span class="p">,</span> <span class="n">mb</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
</span><span class='line'>  <span class="n">GDKfree</span><span class="p">(</span><span class="n">pc</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">varcnt</span> <span class="p">)</span> <span class="n">GDKfree</span><span class="p">(</span><span class="n">varcnt</span><span class="p">);</span>
</span><span class='line'>  <span class="n">DEBUGoptimizers</span>
</span><span class='line'>      <span class="n">mnstr_printf</span><span class="p">(</span><span class="n">cntxt</span><span class="o">-&gt;</span><span class="n">fdout</span><span class="p">,</span><span class="s">&quot;#opt_joinpath: %d statements glued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">actions</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">actions</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">ForgeBrain</span></span>

      








  


<time datetime="2013-04-24T20:02:00+08:00" pubdate data-updated="true">Apr 24<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/monetdb/'>MonetDB</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
</div>
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/04/10/bugs/" title="Previous Post: Bugs">&laquo; Bugs</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/04/26/depression/" title="Next Post: Depression">Depression &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>Forge brain as steal</p>
  <p>Keep learning and moving</p>
  <p>Email:juda-zhida@qq.com</p>
</section>

<section>
<h1>Tags</h1>
<span class='categories_tag'> <a href='/blog/categories/intern' style='font-size: 112.0%'>Intern</a>  <a href='/blog/categories/linux' style='font-size: 106.0%'>Linux</a>  <a href='/blog/categories/monetdb' style='font-size: 160.0%'>Monetdb</a>  <a href='/blog/categories/psychology' style='font-size: 124.0%'>Psychology</a>  <a href='/blog/categories/sql' style='font-size: 112.0%'>Sql</a> </span>
</section>

<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/intern/'>Intern (2)</a></li>
<li class='category'><a href='/blog/categories/linux/'>Linux (1)</a></li>
<li class='category'><a href='/blog/categories/monetdb/'>MonetDB (10)</a></li>
<li class='category'><a href='/blog/categories/sql/'>SQL (2)</a></li>
<li class='category'><a href='/blog/categories/psychology/'>psychology (4)</a></li>

  </ul>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/09/procrastination/">Procrastination</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/23/goal-setting-process/">Goal-Setting Process</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/08/interprocess-communications/">Interprocess Communications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/06/places-of-historical-interest/">Places of Historical Interest</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/28/sql-proccessing/">SQL Proccessing</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Neighbour</h1>
  <ul>
	<li><a href="http://www.everet.org">EverET |</a><a href="http://coolshell.cn/"> CoolShell</a></li>
	<li><a href="http://www.kidsang.com">KidSang |</a><a href="http://jiafei.org/"> JiaFei</a></li>
	<li><a href="http://xuyufish.com">Fish |</a><a href="http://rdc.taobao.com/blog/cs/"> Taobao</a></li>
  </ul>
</section>
<section>
    <h1>Recent Comments</h1>
    <script type="text/javascript" src="http://coolbrain.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=200"></script>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - ForgeBrain -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'coolbrain';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://coolbrain.github.com/blog/2013/04/24/monetdb-optimizers/';
        var disqus_url = 'http://coolbrain.github.com/blog/2013/04/24/monetdb-optimizers/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
