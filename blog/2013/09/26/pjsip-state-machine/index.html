
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>pjsip状态机 - ForgeBrain</title>
  <meta name="author" content="ForgeBrain">

  
  <meta name="description" content="近期在voip skeleton上增加了一个简单的状态机，分别是当前的状态（current state），事件（event），新的状态（new state），操作（action），使用的是list链表的方式管理，实现动态注册状态的处理。在pjsip 事务（transation state &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://coolbrain.github.com/blog/2013/09/26/pjsip-state-machine/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="ForgeBrain" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39361176-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:coolbrain.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
    <li><a href="/">
        <span class="blue_light">
            ForgeBrain
        </span>
       
           <span class="blue_dark">
             Hardworking.
           </span>
       
    </a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Pjsip状态机</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-26T23:38:00+08:00" pubdate data-updated="true">Sep 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p><p>近期在voip skeleton上增加了一个简单的状态机，分别是当前的状态（current state），事件（event），新的状态（new state），操作（action），使用的是list链表的方式管理，实现动态注册状态的处理。在pjsip 事务（transation state machine）状态机使用的是用数组的方式来实现，数组的下标为状态，内容为操作handle。</p>
<!-- more -->
<p>pjsip的事务状态用枚举定义：</p></p></blockquote>

<figure class='code'><figcaption><span>transation状态声明  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * This enumeration represents transaction state.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">typedef</span> <span class="k">enum</span> <span class="n">pjsip_tsx_state_e</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_NULL</span><span class="p">,</span>   <span class="cm">/**&lt; For UAC, before any message is sent.   */</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_CALLING</span><span class="p">,</span>    <span class="cm">/**&lt; For UAC, just after request is sent.   */</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_TRYING</span><span class="p">,</span> <span class="cm">/**&lt; For UAS, just after request is received.*/</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_PROCEEDING</span><span class="p">,</span> <span class="cm">/**&lt; For UAS/UAC, after provisional response.*/</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_COMPLETED</span><span class="p">,</span>  <span class="cm">/**&lt; For UAS/UAC, after final response.     */</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_CONFIRMED</span><span class="p">,</span>  <span class="cm">/**&lt; For UAS, after ACK is received.        */</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_TERMINATED</span><span class="p">,</span> <span class="cm">/**&lt; For UAS/UAC, before it&#39;s destroyed.    */</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_DESTROYED</span><span class="p">,</span>  <span class="cm">/**&lt; For UAS/UAC, will be destroyed now.    */</span>
</span><span class='line'>    <span class="n">PJSIP_TSX_STATE_MAX</span>        <span class="cm">/**&lt; Number of states.              */</span>
</span><span class='line'><span class="p">}</span> <span class="n">pjsip_tsx_state_e</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>pjsip状态处理函数的定义：</p></p></blockquote>

<figure class='code'><figcaption><span>transation状态处理函数声明  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_null</span><span class="p">(</span>      <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_calling</span><span class="p">(</span> <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_trying</span><span class="p">(</span>      <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_proceeding_uas</span><span class="p">(</span> <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_proceeding_uac</span><span class="p">(</span> <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_completed_uas</span><span class="p">(</span>   <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_completed_uac</span><span class="p">(</span>   <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_confirmed</span><span class="p">(</span>   <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_terminated</span><span class="p">(</span>  <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_destroyed</span><span class="p">(</span>   <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>pjsip状态机的注册：</p></p></blockquote>

<figure class='code'><figcaption><span>transation 状态注册  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* State handlers for UAC, indexed by state */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">tsx_state_handler_uac</span><span class="p">[</span><span class="n">PJSIP_TSX_STATE_MAX</span><span class="p">])(</span><span class="n">pjsip_transaction</span> <span class="o">*</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">pjsip_event</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_null</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_calling</span><span class="p">,</span>
</span><span class='line'>    <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_proceeding_uac</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_completed_uac</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_confirmed</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_terminated</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_destroyed</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* State handlers for UAS */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">tsx_state_handler_uas</span><span class="p">[</span><span class="n">PJSIP_TSX_STATE_MAX</span><span class="p">])(</span><span class="n">pjsip_transaction</span> <span class="o">*</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">pjsip_event</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_null</span><span class="p">,</span>
</span><span class='line'>    <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_trying</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_proceeding_uas</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_completed_uas</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_confirmed</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_terminated</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">tsx_on_state_destroyed</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>当相应的事件来临时，就调用相应的处理函数handle和改变自身的状态，如ack来临，或者超时重传：</p></p></blockquote>

<figure class='code'><figcaption><span>transation调用相应的处理函数  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * State Calling is for UAC after it sends request but before any responses</span>
</span><span class='line'><span class="cm"> * is received.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="n">pj_status_t</span> <span class="nf">tsx_on_state_calling</span><span class="p">(</span> <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">pjsip_event</span> <span class="o">*</span><span class="n">event</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">pj_assert</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">PJSIP_TSX_STATE_CALLING</span><span class="p">);</span>
</span><span class='line'>    <span class="n">pj_assert</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">PJSIP_ROLE_UAC</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PJSIP_EVENT_TIMER</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>  <span class="n">event</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">entry</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">pj_status_t</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Retransmit the request. */</span>
</span><span class='line'>        <span class="n">status</span> <span class="o">=</span> <span class="n">tsx_retransmit</span><span class="p">(</span> <span class="n">tsx</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">PJ_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PJSIP_EVENT_TIMER</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>         <span class="n">event</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">entry</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Cancel retransmission timer. */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">pjsip_endpt_cancel_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">);</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">transport_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSX_HAS_PENDING_RESCHED</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Set status code */</span>
</span><span class='line'>  <span class="n">tsx_set_status_code</span><span class="p">(</span><span class="n">tsx</span><span class="p">,</span> <span class="n">PJSIP_SC_TSX_TIMEOUT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Inform TU. */</span>
</span><span class='line'>  <span class="n">tsx_set_state</span><span class="p">(</span> <span class="n">tsx</span><span class="p">,</span> <span class="n">PJSIP_TSX_STATE_TERMINATED</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">PJSIP_EVENT_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Transaction is destroyed */</span>
</span><span class='line'>  <span class="c1">//return PJSIP_ETSXDESTROYED;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PJSIP_EVENT_RX_MSG</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pjsip_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">code</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Get message instance */</span>
</span><span class='line'>  <span class="n">msg</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">body</span><span class="p">.</span><span class="n">rx_msg</span><span class="p">.</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">msg_info</span><span class="p">.</span><span class="n">msg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Better be a response message. */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PJSIP_RESPONSE_MSG</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">PJSIP_ENOTRESPONSEMSG</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">code</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* If the response is final, cancel both retransmission and timeout</span>
</span><span class='line'><span class="cm">  * timer.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&gt;=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">pjsip_endpt_cancel_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">);</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">lock_timer</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>      <span class="n">pjsip_endpt_cancel_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">);</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">unlock_timer</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/* Cancel retransmit timer (for non-INVITE transaction, the</span>
</span><span class='line'><span class="cm">      * retransmit timer will be rescheduled at T2.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">pjsip_endpt_cancel_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">);</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* For provisional response, only cancel retransmit when this</span>
</span><span class='line'><span class="cm">      * is an INVITE transaction. For non-INVITE, section 17.1.2.1</span>
</span><span class='line'><span class="cm">      * of RFC 3261 says that:</span>
</span><span class='line'><span class="cm">      *  - retransmit timer is set to T2</span>
</span><span class='line'><span class="cm">      *  - timeout timer F is not deleted.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">PJSIP_INVITE_METHOD</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/* Cancel timeout timer */</span>
</span><span class='line'>      <span class="n">lock_timer</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>      <span class="n">pjsip_endpt_cancel_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">);</span>
</span><span class='line'>      <span class="n">unlock_timer</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">is_reliable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">TIMER_ACTIVE</span><span class="p">;</span>
</span><span class='line'>          <span class="n">pjsip_endpt_schedule_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span>
</span><span class='line'>                         <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">retransmit_timer</span><span class="p">,</span>
</span><span class='line'>                         <span class="o">&amp;</span><span class="n">t2_timer_val</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">transport_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSX_HAS_PENDING_RESCHED</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Discard retransmission message if it is not INVITE.</span>
</span><span class='line'><span class="cm">  * The INVITE tdata is needed in case we have to generate ACK for</span>
</span><span class='line'><span class="cm">  * the final response.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="cm">/* Keep last_tx for authorization. */</span>
</span><span class='line'>  <span class="c1">//blp: always keep last_tx until transaction is destroyed</span>
</span><span class='line'>  <span class="c1">//code = msg-&gt;line.status.code;</span>
</span><span class='line'>  <span class="c1">//if (tsx-&gt;method.id != PJSIP_INVITE_METHOD &amp;&amp; code!=401 &amp;&amp; code!=407) {</span>
</span><span class='line'>  <span class="c1">//    pjsip_tx_data_dec_ref(tsx-&gt;last_tx);</span>
</span><span class='line'>  <span class="c1">//    tsx-&gt;last_tx = NULL;</span>
</span><span class='line'>  <span class="c1">//}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Processing is similar to state Proceeding. */</span>
</span><span class='line'>  <span class="n">tsx_on_state_proceeding_uac</span><span class="p">(</span> <span class="n">tsx</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pj_assert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Unexpected event&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">PJ_EBUG</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">PJ_SUCCESS</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><p>pjsip 事务相应状态改变函数：</p></p></blockquote>

<figure class='code'><figcaption><span>transation状态改变和改变相应处理函数  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Set transaction state, and inform TU about the transaction state change.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">tsx_set_state</span><span class="p">(</span> <span class="n">pjsip_transaction</span> <span class="o">*</span><span class="n">tsx</span><span class="p">,</span>
</span><span class='line'>             <span class="n">pjsip_tsx_state_e</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>             <span class="n">pjsip_event_id_e</span> <span class="n">event_src_type</span><span class="p">,</span>
</span><span class='line'>                           <span class="kt">void</span> <span class="o">*</span><span class="n">event_src</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">pjsip_tsx_state_e</span> <span class="n">prev_state</span> <span class="o">=</span> <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* New state must be greater than previous state */</span>
</span><span class='line'>    <span class="n">pj_assert</span><span class="p">(</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">PJ_LOG</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">obj_name</span><span class="p">,</span> <span class="s">&quot;State changed from %s to %s, event=%s&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">state_str</span><span class="p">[</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">],</span> <span class="n">state_str</span><span class="p">[</span><span class="n">state</span><span class="p">],</span>
</span><span class='line'>               <span class="n">pjsip_event_str</span><span class="p">(</span><span class="n">event_src_type</span><span class="p">)));</span>
</span><span class='line'>    <span class="n">pj_log_push_indent</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Change state. */</span>
</span><span class='line'>    <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Update the state handlers. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">role</span> <span class="o">==</span> <span class="n">PJSIP_ROLE_UAC</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state_handler</span> <span class="o">=</span> <span class="n">tsx_state_handler_uac</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">state_handler</span> <span class="o">=</span> <span class="n">tsx_state_handler_uas</span><span class="p">[</span><span class="n">state</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Before informing TU about state changed, inform TU about</span>
</span><span class='line'><span class="cm">     * rx event.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">event_src_type</span><span class="o">==</span><span class="n">PJSIP_EVENT_RX_MSG</span> <span class="o">&amp;&amp;</span> <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">tsx_user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pjsip_rx_data</span> <span class="o">*</span><span class="n">rdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">pjsip_rx_data</span><span class="o">*</span><span class="p">)</span> <span class="n">event_src</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pj_assert</span><span class="p">(</span><span class="n">rdata</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">rdata</span><span class="o">-&gt;</span><span class="n">msg_info</span><span class="p">.</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PJSIP_RESPONSE_MSG</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>         <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">tsx_user</span><span class="o">-&gt;</span><span class="n">on_rx_response</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="p">(</span><span class="o">*</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">tsx_user</span><span class="o">-&gt;</span><span class="n">on_rx_response</span><span class="p">)(</span><span class="n">rdata</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Inform TU about state changed. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">tsx_user</span> <span class="o">&amp;&amp;</span> <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">tsx_user</span><span class="o">-&gt;</span><span class="n">on_tsx_state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pjsip_event</span> <span class="n">e</span><span class="p">;</span>
</span><span class='line'>  <span class="n">PJSIP_EVENT_INIT_TSX_STATE</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">tsx</span><span class="p">,</span> <span class="n">event_src_type</span><span class="p">,</span> <span class="n">event_src</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">prev_state</span><span class="p">);</span>
</span><span class='line'>  <span class="p">(</span><span class="o">*</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">tsx_user</span><span class="o">-&gt;</span><span class="n">on_tsx_state</span><span class="p">)(</span><span class="n">tsx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* When the transaction is terminated, release transport, and free the</span>
</span><span class='line'><span class="cm">     * saved last transmitted message.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">PJSIP_TSX_STATE_TERMINATED</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pj_time_val</span> <span class="n">timeout</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* If we&#39;re still waiting for a message to be sent.. */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">transport_flag</span> <span class="o">&amp;</span> <span class="n">TSX_HAS_PENDING_TRANSPORT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/* Disassociate ourselves from the outstanding transmit data</span>
</span><span class='line'><span class="cm">      * so that when the send callback is called we will be able</span>
</span><span class='line'><span class="cm">      * to ignore that (otherwise we&#39;ll get assertion, see</span>
</span><span class='line'><span class="cm">      * http://trac.pjsip.org/repos/ticket/1033)</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">pending_tx</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">pending_tx</span><span class="o">-&gt;</span><span class="n">mod_data</span><span class="p">[</span><span class="n">mod_tsx_layer</span><span class="p">.</span><span class="n">mod</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">pending_tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">transport_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSX_HAS_PENDING_TRANSPORT</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">lock_timer</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Cancel timeout timer. */</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">pjsip_endpt_cancel_timer</span><span class="p">(</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">);</span>
</span><span class='line'>      <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">TIMER_ACTIVE</span><span class="p">;</span>
</span><span class='line'>  <span class="n">pjsip_endpt_schedule_timer</span><span class="p">(</span> <span class="n">tsx</span><span class="o">-&gt;</span><span class="n">endpt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsx</span><span class="o">-&gt;</span><span class="n">timeout_timer</span><span class="p">,</span>
</span><span class='line'>                  <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">unlock_timer</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">PJSIP_TSX_STATE_DESTROYED</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Unregister transaction. */</span>
</span><span class='line'>  <span class="n">mod_tsx_layer_unregister_tsx</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Destroy transaction. */</span>
</span><span class='line'>  <span class="n">tsx_destroy</span><span class="p">(</span><span class="n">tsx</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pj_log_pop_indent</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">ForgeBrain</span></span>

      








  


<time datetime="2013-09-26T23:38:00+08:00" pubdate data-updated="true">Sep 26<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/pjsip/'>Pjsip</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
</div>
    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/09/26/regular-expression/" title="Previous Post: 正则表达式">&laquo; 正则表达式</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/09/29/train-summary/" title="Next Post: 接近尾声 两手空空">接近尾声 两手空空 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Motto</h1>
  <p>Reading is fantastic</p>
  <p>Read incomparable book</p>
  <p>Be enthusiastic in studying</p>
  <p>PS:email:juda-zhida@qq.com</p>
</section>

<section>
<h1>Tags</h1>
<span class='categories_tag'> <a href='/blog/categories/english' style='font-size: 109.47368421052632%'>English</a>  <a href='/blog/categories/entertainment' style='font-size: 109.47368421052632%'>Entertainment</a>  <a href='/blog/categories/health' style='font-size: 103.15789473684211%'>Health</a>  <a href='/blog/categories/intern' style='font-size: 106.3157894736842%'>Intern</a>  <a href='/blog/categories/journey' style='font-size: 109.47368421052632%'>Journey</a>  <a href='/blog/categories/library' style='font-size: 106.3157894736842%'>Library</a>  <a href='/blog/categories/life' style='font-size: 118.94736842105263%'>Life</a>  <a href='/blog/categories/linux' style='font-size: 122.10526315789474%'>Linux</a>  <a href='/blog/categories/literature' style='font-size: 106.3157894736842%'>Literature</a>  <a href='/blog/categories/monetdb' style='font-size: 128.42105263157896%'>Monetdb</a>  <a href='/blog/categories/pjsip' style='font-size: 106.3157894736842%'>Pjsip</a>  <a href='/blog/categories/psychology' style='font-size: 106.3157894736842%'>Psychology</a>  <a href='/blog/categories/socket' style='font-size: 106.3157894736842%'>Socket</a>  <a href='/blog/categories/sql' style='font-size: 106.3157894736842%'>Sql</a>  <a href='/blog/categories/tp-link' style='font-size: 160.0%'>Tp-link</a>  <a href='/blog/categories/window' style='font-size: 103.15789473684211%'>Window</a> </span>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/01/intern-summary/">你知道了你 你就不是你</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/16/follow-version/">承上启下 向下兼容</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/16/view-of-shenzhen/">依山伴水 绿水长流</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/15/live-by-yourself/">除了我的无知，我什么都不知道</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/14/fairy-story/">青衫磊落险峰行</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Neighbour</h1>
  <ul>
	<li><a href="http://www.everet.org">EverET |</a><a href="http://coolshell.cn/"> CoolShell |</a> 
		<a href="http://blog.youxu.info">XuYou </a></li>
	<li><a href="http://www.kidsang.com">KidSang |</a><a href="http://jiafei.org/"> JiaFei |</a>
		<a href="http://dbanotes.net/">DBanotes</a></li>
	<li><a href="http://xuyufish.com">Fish |</a><a href="http://rdc.taobao.com/blog/cs/"> Taobao |</a>
		<a href="http://stackoverflow.com">Stackoverflow</a></li>
  </ul>
</section>
<section>
    <h1>Recent Comments</h1>
    <script type="text/javascript" src="http://coolbrain.disqus.com/recent_comments_widget.js?num_items=5&hide_avatars=0&avatar_size=32&excerpt_length=200"></script>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - ForgeBrain -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'coolbrain';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://coolbrain.github.com/blog/2013/09/26/pjsip-state-machine/';
        var disqus_url = 'http://coolbrain.github.com/blog/2013/09/26/pjsip-state-machine/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
